<!DOCTYPE html>
<html>

<head>
  <title>TMDb Ratings Demo</title>
  <style>
        /* ---------- CONFIDENCE BAR ---------- */
        .confidence-bar-container {
          margin-top: 0.5rem;
          background: #1e293b;
          border-radius: 6px;
          height: 16px;
          width: 100%;
          position: relative;
          overflow: hidden;
          box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .confidence-bar {
          height: 100%;
          background: linear-gradient(90deg, #fbbf24 0%, #22d3ee 100%);
          border-radius: 6px 0 0 6px;
          transition: width 0.4s cubic-bezier(.4,2,.6,1);
        }
        .confidence-label {
          position: absolute;
          right: 10px;
          top: 0;
          height: 100%;
          display: flex;
          align-items: center;
          font-size: 0.8rem;
          color: #fff;
          font-weight: 600;
          text-shadow: 0 1px 2px #000a;
          pointer-events: none;
        }
    /* ---------- CSS RESET ---------- */
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: #102e54;
      color: #e5e7eb;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* ---------- PAGE LAYOUT ---------- */
    body {
      padding: 1.5rem 2rem;
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 5rem;
      letter-spacing: -0.02em;

    }

    p {
      margin-top: 0;
      color: #9ca3af;
    }

    /* ---------- STATUS TEXT ---------- */
    #status {
      margin: 1rem 0 1.5rem;
      font-size: 0.9rem;
      color: #facc15;
    }

    /* ---------- GRID ---------- */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 2rem;
    }

    /* ---------- MOVIE CARD ---------- */
    .card {
      background: linear-gradient(180deg, #111827, #0b0f14);
      border-radius: 20px;
      overflow: hidden;
      box-shadow:
        0 14px 36px rgba(0, 0, 0, 0.50),
        inset 0 1px 0 rgba(255, 255, 255, 0.04);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      cursor: pointer;
      min-width: 230px;
      max-width: 320px;
    }

    .card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow:
        0 20px 50px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    /* ---------- POSTER ---------- */
    .card img {
      width: 100%;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      display: block;
      background: #020617;
      min-height: 345px;
      max-height: 420px;
    }

    /* ---------- CARD CONTENT ---------- */
    .card-content {
      padding: 1.1rem 1.2rem 1.3rem;
    }

    .card-title {
      font-size: 1.15rem;
      font-weight: 600;
      line-height: 1.25;
      margin-bottom: 0.4rem;
    }

    /* ---------- RATING ---------- */
    .card-rating {
      font-size: 0.85rem;
      color: #fbbf24;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.2rem;
    }

    /* ---------- OPTIONAL TAGS ---------- */
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.4rem;
    }

    .tag {
      font-size: 0.65rem;
      padding: 0.2rem 0.45rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      color: #9ca3af;
    }

    /* ---------- LINKS ---------- */
    a {
      color: inherit;
      text-decoration: none;
    }

    /* ---------- RESPONSIVE ---------- */
    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }

      h1 {
        font-size: 1.4rem;
      }
    }

    /* Poster fixes */
    .card img.card-poster {
      width: 100%;
      height: auto;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      object-fit: cover;
    }

    /* Unused movie badge */
    .unused-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #6b7280cc;
      color: #fff;
      font-size: 0.7rem;
      padding: 0.25em 0.7em;
      border-radius: 999px;
      z-index: 2;
      font-weight: 600;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }

    .card.unused .card-poster {
      filter: grayscale(0.85) brightness(0.85);
    }
    .card.unused {
      opacity: 0.85;
    }

    /* Card content padding */
    .card-content {
      padding: 0.75rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    /* Card title styling */
    .card-title {
      font-size: 1rem;
      font-weight: 600;
      line-height: 1.2;
      color: #f3f4f6;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    /* Rating styling */
    .card-rating {
      font-size: 0.85rem;
      color: #fbbf24;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .user-rating {
      color: #34d399; /* green color for user rating */
    }

    /* Tags styling */
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }

    .tag {
      font-size: 0.65rem;
      padding: 0.2rem 0.45rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <h1>User's Liked Movies</h1>
  <div id="liked-movies" class="grid"></div>
  <h1>Recommended Movies</h1>
  <div id="movies" class="grid"></div>
  <script>
    const container = document.getElementById("movies");
    const likedContainer = document.getElementById("liked-movies");

    // Unique identifier for the user (can be generated once per browser)
    const USER_ID_KEY = "user_id";
    let userId = localStorage.getItem(USER_ID_KEY);
    if (!userId) {
      userId = crypto.randomUUID();
      localStorage.setItem(USER_ID_KEY, userId);
    }

    // Function to redirect user to TMDb authentication
    async function redirectToTmdbAuth() {
      try {
        const res = await fetch("http://127.0.0.1:8000/api/request-token");
        const data = await res.json();
        const requestToken = data.request_token;

        const redirectUrl = encodeURIComponent("http://127.0.0.1:8000/");
        const tmdbUrl = `https://www.themoviedb.org/authenticate/${requestToken}?redirect_to=${redirectUrl}`;

        window.location.href = tmdbUrl; // redirect user to TMDb
      } catch (err) {
        console.error("Failed to get TMDb request token:", err);
        container.innerHTML = "<p>Unable to connect to TMDb. Try again later.</p>";
      }
    }

    window.onload = async () => {
      const params = new URLSearchParams(window.location.search);
      const requestToken = params.get("request_token"); // token from TMDb redirect

      let url = `http://127.0.0.1:8000/api/get-recommendations?user_id=${userId}&top_n=20`;
      if (requestToken) url += `&request_token=${requestToken}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
          console.warn("Session invalid or expired, redirecting to TMDb auth...");
          await redirectToTmdbAuth();
          return;
        }

        container.innerHTML = "";

        data.recommendations.forEach(movie => {
          const poster = movie.poster_path
            ? `https://image.tmdb.org/t/p/w300${movie.poster_path}`
            : "";

          let tagsHtml = "";
          // genres are separated by | in the API response
          genres = movie.genres ? movie.genres.split("|") : [];
          if (Array.isArray(genres)) {
            genres.forEach(genre => {
              tagsHtml += `<span class="tag">${genre}</span>`;
            });
          }

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
        <a href="${movie.url}" target="_blank">
          ${poster ? `<img src="${poster}" alt="${movie.title}">` : ""}
          <div class="card-content">
            <div class="card-title">${movie.title}</div>
            <div class="card-rating" title="User rating">${Number(movie.vote_average).toFixed(2)}/10 (${movie.vote_count} votes)</div>
            <div class="confidence-bar-container" title="Confidence score">
              <div class="confidence-bar" style="width: ${movie.confidence}%;"></div>
              <span class="confidence-label">${movie.confidence}/100</span>
            </div>
            <div class="tags">${tagsHtml}</div>
          </div>
        </a>
      `;
          container.appendChild(card);
        });

        likedContainer.innerHTML = "";
        data.used_movies.forEach(movie => {
          const poster = movie.poster_path
            ? `https://image.tmdb.org/t/p/w300${movie.poster_path}`
            : "";

          let tagsHtml = "";
          // genres are separated by | in the API response
          genres = movie.genres ? movie.genres.split("|") : [];
          if (Array.isArray(genres)) {
            genres.forEach(genre => {
              tagsHtml += `<span class="tag">${genre}</span>`;
            });
          }

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
        <a href="${movie.url}" target="_blank">
          ${poster ? `<img src="${poster}" alt="${movie.title}">` : ""}
          <div class="card-content">
            <div class="card-title">${movie.title}</div>
            <div class="card-rating" title="User rating">${Number(movie.vote_average).toFixed(2)}/10 (${movie.vote_count} votes)</div>
            <div class="card-rating user-rating" title="Your rating">Your rating: ${Math.round(Number(movie.user_rating))}/10</div>
            <div class="tags">${tagsHtml}</div>
          </div>
        </a>
      `;
          likedContainer.appendChild(card);
        });

        data.unused_movies.forEach(movie => {
          const poster = movie.poster_path
            ? `https://image.tmdb.org/t/p/w300${movie.poster_path}`
            : "";

          let tagsHtml = "";
          // genres are separated by | in the API response
          genres = movie.genres ? movie.genres.split("|") : [];
          if (Array.isArray(genres)) {
            genres.forEach(genre => {
              tagsHtml += `<span class="tag">${genre}</span>`;
            });
          }

          const card = document.createElement("div");
          card.className = "card unused";
          card.style.position = "relative";
          card.innerHTML = `
        <a href="${movie.url}" target="_blank">
          <span class="unused-badge">Not used</span>
          ${poster ? `<img src="${poster}" alt="${movie.title}" class="card-poster">` : ""}
          <div class="card-content">
            <div class="card-title">${movie.title}</div>
            <div class="card-rating" title="User rating">${Number(movie.vote_average).toFixed(0)}/10 (${movie.vote_count} votes)</div>
            <div class="card-rating user-rating" title="Your rating">Your rating: ${Math.round(Number(movie.user_rating))}/10</div>
            <div class="tags">${tagsHtml}</div>
          </div>
        </a>
      `;
          likedContainer.appendChild(card);
        });

      } catch (err) {
        console.error("Error fetching recommendations:", err);
        container.innerHTML = "<p>Error fetching recommendations.</p>";
        await redirectToTmdbAuth();
      }
    };
  </script>


</body>

</html>